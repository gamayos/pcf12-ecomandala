<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>H3 Hexagonal Grid Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Include Mapbox GL CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css' rel='stylesheet' />
    <!-- Include H3 JavaScript library -->
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        body { margin:0; padding:0; }
        #container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        #map {
            width: 70%;
            height: 100%;
        }
        #info {
            width: 30%;
            height: 100%;
            padding: 10px;
            overflow-y: auto;
            box-sizing: border-box;
            border-left: 1px solid #ccc;
        }
        #generate-btn {
            background-color: grey;
            color: white;
            padding: 10px;
            border: none;
            margin-top: 20px;
            width: 100%;
            font-size: 16px;
            cursor: not-allowed;
        }
        #generate-btn.active {
            background-color: red;
            cursor: pointer;
        }
        #generated-image {
            display: none;
            margin-top: 20px;
            width: 100%;
            height: auto;
        }
        #tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }
        .tab-button {
            background-color: grey;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        .tab-button.active {
            background-color: red;
        }
        .tab-content {
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="info">
            <div id="tabs">
                <button class="tab-button" onclick="openTab(event, 'explore')">Explore</button>
                <button class="tab-button" onclick="openTab(event, 'my-sites')">My Sites</button>
            </div>
            <div id="explore" class="tab-content active">
                <h2>Explore</h2>
                <div id="hex-info">Click on a hexagon to see its information.</div>
                <button id="generate-btn" disabled>Generate</button>
                <img id="generated-image" src="" alt="Generated Content" />
            </div>
            <div id="my-sites" class="tab-content">
                <h2>My Sites</h2>
                <div class="site-container">
                    <p>H3index: <span id="h3index-1">8a2a1072b59ffff</span></p>
                    <p>Time-stamp: <span id="timestamp-1">2023-09-16T12:00:00Z</span></p>
                    <p>Status: <span id="status-1">Active</span></p>
                </div>
                <div class="site-container">
                    <p>H3index: <span id="h3index-2">8a2a1072b5affff</span></p>
                    <p>Time-stamp: <span id="timestamp-2">2023-09-16T12:30:00Z</span></p>
                    <p>Status: <span id="status-2">Inactive</span></p>
                </div>
                <div class="site-container">
                    <p>H3index: <span id="h3index-3">8a2a1072b5bffff</span></p>
                    <p>Time-stamp: <span id="timestamp-3">2023-09-16T13:00:00Z</span></p>
                    <p>Status: <span id="status-3">Pending</span></p>
                </div>
            </div>
        </div>
    </div>
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
    </script>
    <!-- Include Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js'></script>
    <!-- Add your own Mapbox access token -->
    <script>
        //mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN'; // Replace with your Mapbox access token
	  	mapboxgl.accessToken =
	    "pk.eyJ1IjoiZ2lyaXNocGFsbGFnYXR0aSIsImEiOiJja2h6NGVuc20wYndjMnlxaDExbzlsa3B2In0.e94ZfcoPleAA2nqjeX10ag";
    </script>
    <script>
        const EcoManApp = {
            config: {
                apiUrl: "https://us-central1-ecomandala.cloudfunctions.net/ecomandala",
                theme: "dark"
            },
            state: {
                h3index: null
            }
        };

        var map = new mapboxgl.Map({
            container: 'map',
            //style: 'mapbox://styles/mapbox/streets-v12',
            //style: 'mapbox://styles/mapbox/satellite-v9',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [0, 0],
            zoom: 2
        });

        var resolution = 9; // Declare resolution variable globally
        var selectedHexId = null; // To keep track of the selected hexagon

        map.on('load', function() {
            generateHexagons();
        });

        map.on('moveend', function() {
            generateHexagons();
        });

        function generateHexagons() {
            var bounds = map.getBounds();
            var sw = bounds.getSouthWest();
            var ne = bounds.getNorthEast();

            var zoom = map.getZoom();
            //var resolution = Math.max(1, Math.min(8, Math.floor(zoom)));
            //resolution = Math.max(1, Math.min(8, Math.floor(zoom) - 1));
            resolution = Math.max(0, Math.min(15, Math.round(0.7 * zoom - 2)));

            var polygon = [[
                [sw.lat, sw.lng],
                [sw.lat, ne.lng],
                [ne.lat, ne.lng],
                [ne.lat, sw.lng],
                [sw.lat, sw.lng]
            ]];

            var hexagons = h3.polygonToCells(polygon, resolution);

            // Now create GeoJSON features for these hexagons
            var features = hexagons.map(function(h3Index) {
                var coordinates = [h3.cellToBoundary(h3Index, true)];
                return {
                    "type": "Feature",
                    "properties": {
                        "h3Index": h3Index
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": coordinates
                    }
                };
            });

            var hexSourceData = {
                "type": "FeatureCollection",
                "features": features
            };

            if (map.getSource('h3-hexagons')) {
                map.getSource('h3-hexagons').setData(hexSourceData);
            } else {
                map.addSource('h3-hexagons', {
                    "type": "geojson",
                    "data": hexSourceData
                });
                map.addLayer({
                    "id": "h3-hexagons",
                    "type": "fill",
                    "source": "h3-hexagons",
                    "paint": {
                        "fill-outline-color": "#000",
                        "fill-color": "#088",
                        "fill-opacity": 0.3
                    }
                });

                // Add a layer for the highlighted hexagon
                map.addLayer({
                    "id": "h3-hexagon-highlight",
                    "type": "line",
                    "source": "h3-hexagons",
                    "paint": {
                        "line-color": "#FF0000",
                        "line-width": 4
                    },
                    "filter": ["==", "h3Index", ""]
                });

                // Add click event
                map.on('click', 'h3-hexagons', function(e) {
                    var h3Index = e.features[0].properties.h3Index;
                    EcoManApp.state.h3index = h3Index
                    showHexInfo(h3Index);
                    highlightHexagon(h3Index);
                });

                // Deselect hexagon when clicking outside
                map.on('click', function(e) {
                    var features = map.queryRenderedFeatures(e.point, { layers: ['h3-hexagons'] });
                    if (features.length === 0) {
                        deselectHexagon();
                    }
                });

                // Change the cursor to a pointer when the mouse is over the hexagons
                map.on('mouseenter', 'h3-hexagons', function () {
                    map.getCanvas().style.cursor = 'pointer';
                });

                // Change it back when it leaves
                map.on('mouseleave', 'h3-hexagons', function () {
                    map.getCanvas().style.cursor = '';
                });
            }

            // Update the highlighted hexagon if needed
            if (selectedHexId) {
                highlightHexagon(selectedHexId);
            }
        }

        function showHexInfo(h3Index) {
            var center = h3.cellToLatLng(h3Index); // returns [lat, lng]
            var boundary = h3.cellToBoundary(h3Index, true); // true for GeoJSON coordinate order [lng, lat]
            var cellResolution = h3.getResolution(h3Index);

            // Get the bounding box of the cell
            var bbox = boundary.reduce(function (bbox, coord) {
                if (!bbox) {
                    return {
                        minLng: coord[0],
                        minLat: coord[1],
                        maxLng: coord[0],
                        maxLat: coord[1]
                    };
                } else {
                    return {
                        minLng: Math.min(bbox.minLng, coord[0]),
                        minLat: Math.min(bbox.minLat, coord[1]),
                        maxLng: Math.max(bbox.maxLng, coord[0]),
                        maxLat: Math.max(bbox.maxLat, coord[1])
                    };
                }
            }, null);

            var infoHtml = '<p><strong>H3 Index:</strong> ' + h3Index + '</p>';
            infoHtml += '<p><strong>H3 Resolution (Grid Zoom Level):</strong> ' + resolution + '</p>';
            infoHtml += '<p><strong>Center Coordinates:</strong> ' + center[0].toFixed(6) + ', ' + center[1].toFixed(6) + '</p>';
            infoHtml += '<p><strong>Bounding Box:</strong></p>';
            infoHtml += '<ul>';
            infoHtml += '<li>Min Longitude: ' + bbox.minLng.toFixed(6) + '</li>';
            infoHtml += '<li>Min Latitude: ' + bbox.minLat.toFixed(6) + '</li>';
            infoHtml += '<li>Max Longitude: ' + bbox.maxLng.toFixed(6) + '</li>';
            infoHtml += '<li>Max Latitude: ' + bbox.maxLat.toFixed(6) + '</li>';
            infoHtml += '</ul>';

            document.getElementById('hex-info').innerHTML = infoHtml;

            // Update the button based on resolution and selection
            updateGenerateButton(cellResolution);
        }

        function highlightHexagon(h3Index) {
            selectedHexId = h3Index;
            map.setFilter('h3-hexagon-highlight', ['==', 'h3Index', h3Index]);
        }

        function deselectHexagon() {
            selectedHexId = null;
            map.setFilter('h3-hexagon-highlight', ['==', 'h3Index', '']);
            document.getElementById('hex-info').innerHTML = 'Click on a hexagon to see its information.';

            // Deactivate the button
            var generateBtn = document.getElementById('generate-btn');
            generateBtn.classList.remove('active');
            generateBtn.disabled = true;
            // Inside deselectHexagon()
            document.getElementById('generated-image').style.display = 'none';

            // Update the button
            updateGenerateButton();
        }
        
        // Update the Generate button label and state
        function updateGenerateButton(cellResolution) {
            var generateBtn = document.getElementById('generate-btn');
            var imgElement = document.getElementById('generated-image');
            var buttonLabel = '';

            if (cellResolution === undefined) {
                // No cell selected
                generateBtn.disabled = true;
                generateBtn.classList.remove('active');
                if (resolution < 9) {
                    buttonLabel = 'Zoom in to Generate';
                } else if (resolution > 9) {
                    buttonLabel = 'Zoom out to Generate';
                } else {
                    buttonLabel = 'Select a cell to Generate';
                }
            } else {
                // Cell is selected
                if (cellResolution < 9) {
                    generateBtn.disabled = true;
                    generateBtn.classList.remove('active');
                    buttonLabel = 'Zoom in to Generate';
                } else if (cellResolution > 9) {
                    generateBtn.disabled = true;
                    generateBtn.classList.remove('active');
                    buttonLabel = 'Zoom out to Generate';
                } else {
                    // Resolution is 9
                    generateBtn.disabled = false;
                    generateBtn.classList.add('active');
                    buttonLabel = 'Generate';
                }
            }

            generateBtn.textContent = buttonLabel;
            // Hide the image when the button label changes
            imgElement.style.display = 'none';
        }

        document.getElementById('generate-btn').addEventListener('click', function() {
            if (!this.disabled) {

                // Replace with your Cloud Function URL
                const cloudFunctionUrl = EcoManApp.config.apiUrl+"/generate/"+EcoManApp.state.h3index;

                // Fetch data from the Cloud Function
                fetch(cloudFunctionUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! Status: ${response.status}');
                    }
                    return response.json();
                })
                .then(data => console.log('Data:', data))
                .catch(error => console.error('Error:', error));

                // Load the image under the button
                var imgElement = document.getElementById('generated-image');
                //imgElement.src = 'https://storage.googleapis.com/0x7ff601307fa7/ecomandala-0001.png';
                imgElement.src = 'https://c-ipfs-gw.nmkr.io/ipfs/QmQeV16RPbzq3Dc49mrY4F51QvcoLszLFVBowTeHSsxMsh';
                imgElement.style.display = 'block';
            }
        });

    </script>
</body>
</html>
